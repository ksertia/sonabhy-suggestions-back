generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id               String         @id @default(uuid())
  firstName        String
  lastName         String
  email            String         @unique
  username         String?        @unique
  phone            String?        @unique
  password         String
  role             Role           @default(USER)
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  comments         Comment[]
  approvedIdeas    Idea[]         @relation("ApprovedBy")
  qualifiedIdeas   Idea[]         @relation("QualifiedBy")
  ideas            Idea[]
  assignedActions  PlanAction[]   @relation("AssignedActions")
  refreshTokens    RefreshToken[]
  AssignedTaches   Tache[]        @relation("AssignedTaches")
  votes            Vote[]
  responsibleIdeas Idea[]         @relation("IdeaResponsibles")
  notifications Notification[]


  @@index([email])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @db.Text
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model Idea {
  id               String        @id @default(uuid())
  title            String
  description      String        @db.Text
  data             Json?
  isAnonymous      Boolean       @default(false)
  forVote          Boolean       @default(false)
  status           Status        @default(SUBMITTED)
  visibility       Visibility    @default(PRIVATE)
  priority         Priority?
  impact           Impact?
  categoryId       String?
  kindId           String?
  userId           String?
  formVariantId    String
  qualifiedById    String?
  qualifiedAt      DateTime?
  approvedById     String?
  approvedAt       DateTime?
  firstName        String?
  lastName         String?
  email            String?
  metadataId       String?       @unique
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  comments         Comment[]
  approvedBy       User?         @relation("ApprovedBy", fields: [approvedById], references: [id])
  category         Category?     @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  formVariant      FormVariant   @relation(fields: [formVariantId], references: [id])
  kind             Kind?         @relation(fields: [kindId], references: [id], onDelete: Restrict)
  metadata         FileMetadata? @relation(fields: [metadataId], references: [id])
  qualifiedBy      User?         @relation("QualifiedBy", fields: [qualifiedById], references: [id])
  user             User?         @relation(fields: [userId], references: [id])
  planActions      PlanAction[]
  votes            Vote[]
  responsibleUsers User[]        @relation("IdeaResponsibles")

  @@index([userId])
  @@index([categoryId])
  @@index([kindId])
  @@index([formVariantId])
  @@index([qualifiedById])
  @@index([approvedById])
  @@index([createdAt])
  @@map("ideas")
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  ideas       Idea[]

  @@map("categories")
}

model Kind {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  ideas       Idea[]

  @@map("kinds")
}

model Vote {
  id        String   @id @default(uuid())
  value     Int
  userId    String
  ideaId    String
  createdAt DateTime @default(now())
  idea      Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, ideaId])
  @@index([ideaId], map: "votes_ideaId_fkey")
  @@map("votes")
}

model PlanAction {
  id          String      @id @default(uuid())
  ideaId      String
  title       String
  description String?     @db.Text
  progress    Int         @default(0)
  status      Plan_Status @default(PENDING)
  tacheId     String?
  deadline    DateTime?
  assignedTo  String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  assignee    User?       @relation("AssignedActions", fields: [assignedTo], references: [id])
  idea        Idea        @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  taches      Tache[]

  @@index([ideaId])
  @@index([assignedTo])
  @@index([deadline])
  @@map("plan_actions")
}

model Tache {
  id           String      @id @default(uuid())
  planActionId String
  title        String
  description  String?     @db.Text
  progress     Int         @default(0)
  status       Plan_Status @default(PENDING)
  deadline     DateTime?
  assignedTo   String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  comments     Comment[]
  assignee     User?       @relation("AssignedTaches", fields: [assignedTo], references: [id])
  planAction   PlanAction  @relation(fields: [planActionId], references: [id], onDelete: Cascade)

  @@index([planActionId])
  @@index([assignedTo])
  @@index([deadline])
  @@map("taches")
}

model FormModel {
  id          String        @id @default(uuid())
  name        String        @unique
  type        String?
  description String?       @db.Text
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  variants    FormVariant[]

  @@map("form_models")
}

model FormVariant {
  id          String      @id @default(uuid())
  modelId     String
  name        String
  description String?     @db.Text
  isDefault   Boolean     @default(false)
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  fields      FormField[]
  model       FormModel   @relation(fields: [modelId], references: [id], onDelete: Cascade)
  ideas       Idea[]

  @@unique([modelId, name])
  @@index([modelId])
  @@map("form_variants")
}

model FormField {
  id          String      @id @default(uuid())
  variantId   String
  label       String
  type        FieldType
  required    Boolean     @default(false)
  options     Json?
  placeholder String?
  helpText    String?
  order       Int
  visibleFor  String?     @default("[]")
  managedOnly Boolean?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  variant     FormVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([variantId, order])
  @@index([variantId])
  @@map("form_fields")
}

model FileMetadata {
  id           String   @id @default(uuid())
  originalName String
  storageName  String   @unique
  mimeType     String
  size         Int
  path         String
  uploadedById String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  idea         Idea?

  @@index([storageName])
  @@map("file_metadata")
}

model Comment {
  id        String   @id @default(uuid())
  ideaId    String?
  tacheId   String?
  userId    String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  idea      Idea?    @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  tache     Tache?   @relation(fields: [tacheId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ideaId])
  @@index([tacheId])
  @@index([userId])
  @@index([createdAt])
  @@map("comments")
}

model Notification {
  id          String    @id @default(uuid())
  title       String
  message     String     @db.Text
  type        NotificationType
  userId      String?    // si la notif est pour un utilisateur spécifique
  role        Role?      // si la notif est pour un rôle (MANAGER, ADMIN)
  target      NotificationTarget @default(USER)
  entityId    String?    // id d'une entité liée (Idea, Comment, Action…)
  entityType  String?    // ex: "IDEA" | "COMMENT" | "ACTION"
  isRead      Boolean    @default(false)
  readAt      DateTime?
  createdAt   DateTime   @default(now())
  user        User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([role])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum NotificationTarget {
  USER       // une seule personne
  ROLE       // tous les membres d'un rôle
  SYSTEM     // tout le monde dans le système
}


enum Role {
  USER
  MANAGER
  ADMIN
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum Impact {
  MINOR
  MODERATE
  MAJOR
  TRANSFORMATIONAL
}

enum FieldType {
  TEXT
  TEXTAREA
  NUMBER
  EMAIL
  DATE
  SELECT
  MULTISELECT
  CHECKBOX
  RADIO
  FILE
}

enum Status {
  SUBMITTED
  APPROVED
  REJECTED
  VALIDATED
  ACTION_PLAN
  QUALIFIED
}

enum Plan_Status {
  PENDING
  IN_PROGRES
  COMPLETED
  CANCELED
}

enum Visibility {
  TEAM
  PUBLIC
  PRIVATE
}
